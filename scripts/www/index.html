<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="format-detection" content="telephone=no">
    <title>仿苹果计算器</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            user-select: none;
        }

        html, body {
            height: 100%;
            overflow: hidden;
        }

        body {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            background: #1c1c1c;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            padding: env(safe-area-inset-top) env(safe-area-inset-right) env(safe-area-inset-bottom) env(safe-area-inset-left);
        }

        .calculator {
            background: #000;
            border-radius: 40px;
            padding: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
            width: 100%;
            max-width: 400px;
        }

        .difference {
            background: #000;
            color: #ff9f0a;
            font-size: 24px;
            font-weight: 300;
            text-align: right;
            padding: 10px 20px 0;
            min-height: 40px;
            white-space: nowrap;
            overflow: hidden;
        }

        .display {
            background: #000;
            color: #fff;
            font-size: 64px;
            font-weight: 300;
            text-align: right;
            padding: 10px 20px 20px;
            margin-bottom: 10px;
            min-height: 100px;
            display: flex;
            align-items: flex-end;
            justify-content: flex-end;
            white-space: nowrap;
            overflow: hidden;
        }

        .display.small-font {
            font-size: 48px;
        }

        .buttons {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 12px;
        }

        button {
            border: none;
            border-radius: 50%;
            font-size: 32px;
            font-weight: 400;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            height: 80px;
            width: 80px;
            display: flex;
            justify-content: center;
            align-items: center;
            aspect-ratio: 1/1;
            position: relative;
            overflow: hidden;
            outline: none;
            -webkit-tap-highlight-color: transparent;
        }
        
        button:focus {
            outline: none;
            box-shadow: none;
        }

        button:active {
            filter: brightness(1.3);
            transition: all 0.1s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .number:active {
            transition: all 0.15s cubic-bezier(0.4, 0, 0.2, 1);
        }

        button::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255, 255, 255, 0.3);
            opacity: 0;
            transition: opacity 0.2s ease;
            border-radius: 50%;
            pointer-events: none;
            z-index: 1;
        }

        button:active::after {
            opacity: 1;
            transition: opacity 0s ease;
        }

        button span {
            position: relative;
            z-index: 2;
        }

        .function {
            background: #a5a5a5;
            color: #000;
        }

        .toggle-sign {
            position: relative;
            font-size: 0;
        }

        .toggle-sign .plus {
            position: absolute;
            top: 22px;
            left: 24px;
            font-size: 20px;
            font-weight: 500;
        }

        .toggle-sign .slash {
            position: absolute;
            top: 22px;
            left: 32px;
            font-size: 32px;
            font-weight: 400;
        }

        .toggle-sign .minus {
            position: absolute;
            top: 30px;
            left: 38px;
            font-size: 24px;
            font-weight: 500;
        }

        .operator {
            background: #ff9f0a;
            color: #fff;
            transition: all 0.2s ease;
            position: relative;
            overflow: hidden;
        }

        .operator.active {
            background: #fff;
            color: #ff9f0a;
        }

        .operator:active {
            background: #ffca7a;
            transition: all 0.1s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .number {
            background: #333;
            color: #fff;
            transition: all 0.6s cubic-bezier(0.25, 0.46, 0.45, 0.94);
        }

        .zero {
            grid-column: span 2;
            width: auto;
            border-radius: 40px;
            justify-content: flex-start;
            padding-left: 32px;
            aspect-ratio: auto;
        }
        
        .zero::after {
            border-radius: 40px;
        }

        @media (max-width: 480px) {
            body {
                padding: env(safe-area-inset-top) env(safe-area-inset-right) env(safe-area-inset-bottom) env(safe-area-inset-left);
                background: #000;
                display: flex;
                justify-content: center;
                align-items: flex-end;
                overflow: hidden;
                min-height: 100vh;
            }
            
            .calculator {
                padding: 20px calc(20px + env(safe-area-inset-right)) calc(20px + env(safe-area-inset-bottom)) calc(20px + env(safe-area-inset-left));
                border-radius: 0;
                box-shadow: none;
                max-width: 100%;
                min-height: 100vh;
                display: flex;
                flex-direction: column;
                justify-content: flex-end;
                width: 100%;
            }

            .display {
                font-size: 64px;
                min-height: 120px;
                padding: 20px;
                margin-bottom: 10px;
            }

            .buttons {
                gap: 10px;
            }

            button {
                height: 75px;
                width: 75px;
                font-size: 30px;
            }

            .zero {
                padding-left: 28px;
            }

            .toggle-sign .plus {
                top: 20px;
                left: 24px;
                font-size: 18px;
            }

            .toggle-sign .slash {
                top: 20px;
                left: 31px;
                font-size: 28px;
            }

            .toggle-sign .minus {
                top: 28px;
                left: 38px;
                font-size: 22px;
            }
        }

        @media (orientation: landscape) and (max-height: 500px) {
            body {
                align-items: flex-start;
                padding: 20px 0 0 0;
                background: #000;
            }

            .calculator {
                padding: 20px;
                border-radius: 0;
                box-shadow: none;
                max-width: 100%;
            }

            .display {
                min-height: 120px;
                font-size: 64px;
                padding: 20px;
            }

            button {
                height: 80px;
                width: 80px;
                font-size: 32px;
            }

            .toggle-sign .plus {
                top: 22px;
                left: 24px;
                font-size: 20px;
            }

            .toggle-sign .slash {
                top: 22px;
                left: 32px;
                font-size: 32px;
            }

            .toggle-sign .minus {
                top: 30px;
                left: 38px;
                font-size: 24px;
            }
        }
    </style>
</head>
<body>
    <div class="calculator">
        <div class="difference" id="difference"></div>
        <div class="display" id="display">0</div>
        <div class="buttons">
            <button class="function" id="clearBtn" onclick="clearAll()">AC</button>
            <button class="function toggle-sign" onclick="toggleSign()">
                <span class="plus">+</span>
                <span class="slash">/</span>
                <span class="minus">−</span>
            </button>
            <button class="function" onclick="percentage()">%</button>
            <button class="operator" data-operator="divide" onclick="setOperator('divide')"><span>÷</span></button>
            
            <button class="number" onclick="appendNumber('7')"><span>7</span></button>
            <button class="number" onclick="appendNumber('8')"><span>8</span></button>
            <button class="number" onclick="appendNumber('9')"><span>9</span></button>
            <button class="operator" data-operator="multiply" onclick="setOperator('multiply')"><span>×</span></button>
            
            <button class="number" onclick="appendNumber('4')"><span>4</span></button>
            <button class="number" onclick="appendNumber('5')"><span>5</span></button>
            <button class="number" onclick="appendNumber('6')"><span>6</span></button>
            <button class="operator" data-operator="subtract" onclick="setOperator('subtract')"><span>−</span></button>
            
            <button class="number" onclick="appendNumber('1')"><span>1</span></button>
            <button class="number" onclick="appendNumber('2')"><span>2</span></button>
            <button class="number" onclick="appendNumber('3')"><span>3</span></button>
            <button class="operator" data-operator="add" onclick="setOperator('add')"><span>+</span></button>
            
            <button class="number zero" onclick="appendNumber('0')"><span>0</span></button>
            <button class="number" onclick="appendDecimal()"><span>.</span></button>
            <button class="operator" data-operator="equals" onclick="calculate()"><span>=</span></button>
        </div>
    </div>

    <script>
        let currentValue = '0';
        let previousValue = '';
        let operator = null;
        let shouldResetDisplay = false;
        let lastOperator = null;
        let lastValue = '';
        let hasInput = false;

        function getCurrentTimeCode() {
            const now = new Date();
            const year = now.getFullYear().toString().slice(-2);
            const month = String(now.getMonth() + 1).padStart(2, '0');
            const day = String(now.getDate()).padStart(2, '0');
            const hours = String(now.getHours()).padStart(2, '0');
            const minutes = String(now.getMinutes()).padStart(2, '0');
            return parseInt(year + month + day + hours + minutes);
        }

        function updateDifference() {
            const differenceElement = document.getElementById('difference');
            const timeCode = getCurrentTimeCode();
            const userInput = parseInt(previousValue) || 0;
            const difference = Math.abs(userInput - timeCode);
            differenceElement.textContent = `差: ${difference}`;
        }

        function updateDisplay() {
            const display = document.getElementById('display');
            let displayValue = currentValue;
            let originalValue = currentValue;
            
            // 处理逗号分隔符（科学计数法除外）
            if (!displayValue.includes('e') && !displayValue.includes('E') && displayValue !== 'Error') {
                // 分离整数和小数部分
                const parts = displayValue.split('.');
                let integerPart = parts[0];
                const decimalPart = parts[1] || '';
                
                // 处理负数
                let sign = '';
                if (integerPart.startsWith('-')) {
                    sign = '-';
                    integerPart = integerPart.substring(1);
                }
                
                // 添加千位分隔符
                integerPart = integerPart.replace(/\B(?=(\d{3})+(?!\d))/g, ',');
                
                // 重新组合
                displayValue = sign + integerPart;
                if (decimalPart || originalValue.endsWith('.')) {
                    displayValue += '.' + decimalPart;
                }
            }
            
            // 检查内容长度，自动调整字号
            if (displayValue.length > 8) {
                // 对于长内容，使用小字号
                display.classList.add('small-font');
                
                // 对于小字号，最多显示13位字符
                if (displayValue.length > 13) {
                    // 计算原始值的截断位置
                    let truncateLength = 13;
                    
                    // 如果添加了逗号，需要根据逗号位置调整截断
                    if (displayValue !== originalValue) {
                        // 找到截断位置对应的原始值位置
                        let originalIndex = 0;
                        let displayIndex = 0;
                        
                        while (displayIndex < 13 && originalIndex < originalValue.length) {
                            if (displayValue[displayIndex] === ',') {
                                displayIndex++;
                            } else {
                                displayIndex++;
                                originalIndex++;
                            }
                        }
                        
                        // 使用原始值截断，然后重新添加逗号
                        const truncatedOriginal = originalValue.substring(0, originalIndex);
                        
                        if (!truncatedOriginal.includes('e') && !truncatedOriginal.includes('E') && truncatedOriginal !== 'Error') {
                            const truncatedParts = truncatedOriginal.split('.');
                            let truncatedInteger = truncatedParts[0];
                            const truncatedDecimal = truncatedParts[1] || '';
                            
                            let truncatedSign = '';
                            if (truncatedInteger.startsWith('-')) {
                                truncatedSign = '-';
                                truncatedInteger = truncatedInteger.substring(1);
                            }
                            
                            truncatedInteger = truncatedInteger.replace(/\B(?=(\d{3})+(?!\d))/g, ',');
                            
                            displayValue = truncatedSign + truncatedInteger;
                            if (truncatedDecimal) {
                                displayValue += '.' + truncatedDecimal;
                            }
                        } else {
                            displayValue = truncatedOriginal;
                        }
                    } else {
                        displayValue = displayValue.substring(0, 13);
                    }
                }
            } else {
                // 对于短内容，使用正常字号
                display.classList.remove('small-font');
            }
            
            display.textContent = displayValue;
        }

        function updateClearButton() {
            const clearBtn = document.getElementById('clearBtn');
            if (hasInput) {
                clearBtn.textContent = 'C';
            } else {
                clearBtn.textContent = 'AC';
            }
        }

        function appendNumber(num) {
            if (isKeyboardLocked) return;
            
            if (shouldResetDisplay) {
                currentValue = num;
                shouldResetDisplay = false;
                lastOperator = null;
                lastValue = '';
            } else {
                if (currentValue === '0' && num !== '0') {
                    currentValue = num;
                } else if (currentValue !== '0' || num !== '0') {
                    // 移除长度限制，允许输入更多数字
                    currentValue += num;
                }
            }
            hasInput = true;
            updateClearButton();
            updateDisplay();
        }

        function appendDecimal() {
            if (isKeyboardLocked) return;
            
            if (shouldResetDisplay) {
                currentValue = '0.';
                shouldResetDisplay = false;
            } else if (!currentValue.includes('.')) {
                currentValue += '.';
            }
            hasInput = true;
            updateClearButton();
            updateDisplay();
        }

        function setOperator(op) {
            if (isKeyboardLocked) return;
            
            if (operator && !shouldResetDisplay) {
                calculate();
            }
            previousValue = currentValue;
            operator = op;
            shouldResetDisplay = true;
            currentValue = '0';
            updateDisplay();
            
            document.querySelectorAll('.operator').forEach(btn => {
                btn.classList.remove('active');
                if (btn.dataset.operator === op) {
                    btn.classList.add('active');
                }
            });
        }

        function calculate() {
            let useLastOperator = false;
            
            if (!operator || !previousValue) {
                if (lastOperator && lastValue) {
                    useLastOperator = true;
                } else {
                    return;
                }
            }
            
            let prev, current, currentOp;
            
            if (useLastOperator) {
                prev = parseFloat(currentValue);
                current = parseFloat(lastValue);
                currentOp = lastOperator;
            } else {
                prev = parseFloat(previousValue);
                current = parseFloat(currentValue);
                currentOp = operator;
                lastOperator = operator;
                lastValue = current;
            }
            
            let result;

            switch (currentOp) {
                case 'add':
                    result = prev + current;
                    break;
                case 'subtract':
                    result = prev - current;
                    break;
                case 'multiply':
                    result = prev * current;
                    break;
                case 'divide':
                    if (current === 0) {
                        result = 'Error';
                    } else {
                        result = prev / current;
                    }
                    break;
                default:
                    return;
            }

            if (result === 'Error') {
                currentValue = 'Error';
            } else {
                // 四舍五入到合适的小数位数
                let roundedResult;
                if (Math.abs(result) >= 1e10 || (Math.abs(result) <= 1e-6 && result !== 0)) {
                    // 对于非常大或非常小的数，使用科学计数法
                    roundedResult = result.toExponential(6);
                    // 简化科学计数法，移除末尾多余的0
                    if (roundedResult.includes('.')) {
                        roundedResult = roundedResult.replace(/\.?0+(e[+-]\d+)$/, '$1');
                    }
                } else {
                    // 对于除法操作，使用toFixed(10)确保显示足够多的小数位，触发小字号
                    if (currentOp === 'divide') {
                        roundedResult = result.toFixed(10);
                        // 移除末尾的0和小数点
                        if (roundedResult.includes('.')) {
                            roundedResult = roundedResult.replace(/\.?0+$/, '');
                        }
                        // 如果结果只剩下小数点，转换为整数
                        if (roundedResult === '.') {
                            roundedResult = '0';
                        }
                    } else {
                        // 对于其他操作，四舍五入到7位小数
                        roundedResult = result.toFixed(7);
                        // 移除末尾的0和小数点
                        roundedResult = parseFloat(roundedResult).toString();
                    }
                }
                currentValue = roundedResult;
            }
            
            operator = null;
            previousValue = '';
            shouldResetDisplay = true;
            isKeyboardLocked = false;
            isShowingDifference = false;
            
            document.querySelectorAll('.operator').forEach(btn => {
                btn.classList.remove('active');
            });
            
            updateDisplay();
        }

        function clearAll() {
            if (isKeyboardLocked) return;
            
            if (hasInput) {
                currentValue = '0';
                hasInput = false;
            } else {
                currentValue = '0';
                previousValue = '';
                operator = null;
                shouldResetDisplay = false;
                lastOperator = null;
                lastValue = '';
                isShowingDifference = false;
                isKeyboardLocked = false;
            }
            
            updateClearButton();
            
            document.querySelectorAll('.operator').forEach(btn => {
                btn.classList.remove('active');
            });
            
            updateDisplay();
            document.getElementById('difference').textContent = '';
        }

        function toggleSign() {
            if (isKeyboardLocked) return;
            
            if (currentValue !== 'Error') {
                if (currentValue.startsWith('-')) {
                    currentValue = currentValue.substring(1);
                } else {
                    currentValue = '-' + currentValue;
                }
                updateDisplay();
            }
        }

        function percentage() {
            if (isKeyboardLocked) return;
            
            if (currentValue !== 'Error') {
                const value = parseFloat(currentValue) / 100;
                let roundedResult;
                if (Math.abs(value) >= 1e10 || (Math.abs(value) <= 1e-6 && value !== 0)) {
                    // 对于非常大或非常小的数，使用科学计数法
                    roundedResult = value.toExponential(6);
                    // 简化科学计数法，移除末尾多余的0
                    if (roundedResult.includes('.')) {
                        roundedResult = roundedResult.replace(/\.?0+(e[+-]\d+)$/, '$1');
                    }
                } else {
                    roundedResult = value.toFixed(10).toString();
                    // 移除末尾的0和小数点
                    roundedResult = parseFloat(roundedResult).toString();
                }
                currentValue = roundedResult;
                updateDisplay();
            }
        }

        function deleteLastDigit() {
            if (isKeyboardLocked) return;
            
            if (currentValue !== 'Error') {
                if (currentValue.length > 1) {
                    currentValue = currentValue.slice(0, -1);
                } else {
                    currentValue = '0';
                }
                updateDisplay();
            }
        }

        let touchStartX = 0;
        let touchStartY = 0;
        let touchEndX = 0;
        let touchEndY = 0;
        let isShowingDifference = false;
        let isKeyboardLocked = false;

        const display = document.getElementById('display');
        
        display.addEventListener('touchstart', (e) => {
            touchStartX = e.changedTouches[0].screenX;
            touchStartY = e.changedTouches[0].screenY;
        });

        display.addEventListener('touchend', (e) => {
            touchEndX = e.changedTouches[0].screenX;
            touchEndY = e.changedTouches[0].screenY;
            handleSwipe();
        });

        display.addEventListener('click', () => {
            if (previousValue && operator === 'add' && !isShowingDifference) {
                const timeCode = getCurrentTimeCode();
                const userInput = parseInt(previousValue) || 0;
                const difference = Math.abs(userInput - timeCode);
                currentValue = difference.toString();
                updateDisplay();
                isShowingDifference = true;
                isKeyboardLocked = true;
            }
        });

        function handleSwipe() {
            const diffX = touchEndX - touchStartX;
            const diffY = touchEndY - touchStartY;
            const minSwipeDistance = 30;

            if (Math.abs(diffX) > Math.abs(diffY) && Math.abs(diffX) > minSwipeDistance) {
                if (diffX < 0) {
                    deleteLastDigit();
                }
            }
        }

        document.addEventListener('keydown', (e) => {
            if (isKeyboardLocked) {
                // 只有等于号可以解锁键盘
                if (e.key === 'Enter' || e.key === '=') {
                    e.preventDefault();
                    calculate();
                    isKeyboardLocked = false;
                    isShowingDifference = false;
                }
                return;
            }
            
            if (e.key >= '0' && e.key <= '9') {
                appendNumber(e.key);
            } else if (e.key === '.') {
                appendDecimal();
            } else if (e.key === '+') {
                setOperator('add');
            } else if (e.key === '-') {
                setOperator('subtract');
            } else if (e.key === '*') {
                setOperator('multiply');
            } else if (e.key === '/') {
                e.preventDefault();
                setOperator('divide');
            } else if (e.key === 'Enter' || e.key === '=') {
                e.preventDefault();
                calculate();
            } else if (e.key === 'Escape' || e.key === 'c' || e.key === 'C') {
                clearAll();
            } else if (e.key === 'Backspace') {
                deleteLastDigit();
            } else if (e.key === '%') {
                percentage();
            }
        });
    </script>
</body>
</html>